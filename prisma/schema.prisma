// MAX-LOYALTY | PRISMA SCHEMA\n// Complete database schema with 14 tables for RBAC and authentication\n\ngenerator client {\n  provider = \"prisma-client-js\"\n}\n\ndatasource db {\n  provider = \"postgresql\"\n  url      = env(\"DATABASE_URL\")\n}\n\n// ═══════════════════════════════════════════════════════════════════════════════\n// USERS & AUTHENTICATION\n// ═══════════════════════════════════════════════════════════════════════════════\n\nenum UserStatus {\n  ACTIVE\n  INACTIVE\n  SUSPENDED\n  BLOCKED\n}\n\nenum SystemRole {\n  OWNER\n  USER\n}\n\nmodel User {\n  id                BigInt    @id @default(autoincrement())\n  email             String    @unique\n  phone             String    @unique\n  firstName         String\n  lastName          String\n  passwordHash      String\n  emailVerified     Boolean   @default(false)\n  status            UserStatus @default(ACTIVE)\n  systemRole        SystemRole @default(USER)\n  mfaEnabled        Boolean   @default(false)\n  mfaSecret         String?\n  lastLoginAt       DateTime?\n  lastLoginIp       String?\n  createdAt         DateTime  @default(now())\n  updatedAt         DateTime  @updatedAt\n\n  // Relations\n  sessions          UserSession[]\n  userRoles         UserRole[]\n  activityLogs      ActivityLog[]\n\n  @@index([email])\n  @@index([phone])\n  @@index([status])\n  @@index([createdAt])\n}\n\nmodel UserSession {\n  id                BigInt    @id @default(autoincrement())\n  userId            BigInt\n  refreshToken      String    @unique\n  ipAddress         String\n  userAgent         String?\n  isActive          Boolean   @default(true)\n  expiresAt         DateTime\n  lastActivityAt    DateTime  @default(now())\n  revokedAt         DateTime?\n  createdAt         DateTime  @default(now())\n\n  // Relations\n  user              User      @relation(fields: [userId], references: [id], onDelete: Cascade)\n\n  @@index([userId])\n  @@index([isActive])\n  @@index([expiresAt])\n}\n\n// ═══════════════════════════════════════════════════════════════════════════════\n// RBAC (ROLE-BASED ACCESS CONTROL)\n// ═══════════════════════════════════════════════════════════════════════════════\n\nmodel Restaurant {\n  id                BigInt    @id @default(autoincrement())\n  name              String\n  code              String    @unique\n  address           String?\n  city              String?\n  region            String?\n  phone             String?\n  email             String?\n  createdAt         DateTime  @default(now())\n  updatedAt         DateTime  @updatedAt\n\n  // Relations\n  roles             Role[]\n  activityLogs      ActivityLog[]\n\n  @@index([code])\n  @@index([city])\n}\n\nmodel Role {\n  id                BigInt    @id @default(autoincrement())\n  name              String\n  description       String?\n  restaurantId      BigInt\n  isDefault         Boolean   @default(false)\n  createdAt         DateTime  @default(now())\n  updatedAt         DateTime  @updatedAt\n\n  // Relations\n  restaurant        Restaurant @relation(fields: [restaurantId], references: [id], onDelete: Cascade)\n  permissions       RolePermission[]\n  userRoles         UserRole[]\n\n  @@unique([name, restaurantId])\n  @@index([restaurantId])\n  @@index([isDefault])\n}\n\nmodel Permission {\n  id                BigInt    @id @default(autoincrement())\n  name              String    @unique\n  description       String?\n  category          String?   // read, write, manage, admin\n\n  // Relations\n  roles             RolePermission[]\n}\n\nmodel RolePermission {\n  id                BigInt    @id @default(autoincrement())\n  roleId            BigInt\n  permissionId      BigInt\n  createdAt         DateTime  @default(now())\n\n  // Relations\n  role              Role      @relation(fields: [roleId], references: [id], onDelete: Cascade)\n  permission        Permission @relation(fields: [permissionId], references: [id], onDelete: Cascade)\n\n  @@unique([roleId, permissionId])\n  @@index([roleId])\n  @@index([permissionId])\n}\n\nmodel UserRole {\n  id                BigInt    @id @default(autoincrement())\n  userId            BigInt\n  roleId            BigInt\n  assignedAt        DateTime  @default(now())\n\n  // Relations\n  user              User      @relation(fields: [userId], references: [id], onDelete: Cascade)\n  role              Role      @relation(fields: [roleId], references: [id], onDelete: Cascade)\n\n  @@unique([userId, roleId])\n  @@index([userId])\n  @@index([roleId])\n}\n\nmodel ActivityLog {\n  id                BigInt    @id @default(autoincrement())\n  userId            BigInt\n  restaurantId      BigInt\n  action            String    // CREATE_ROLE, UPDATE_ROLE, ASSIGN_ROLE, etc.\n  resourceType      String?   // role, permission, user, etc.\n  resourceId        BigInt?\n  details           String?   // JSON\n  createdAt         DateTime  @default(now())\n\n  // Relations\n  user              User      @relation(fields: [userId], references: [id], onDelete: Cascade)\n  restaurant        Restaurant @relation(fields: [restaurantId], references: [id], onDelete: Cascade)\n\n  @@index([userId])\n  @@index([restaurantId])\n  @@index([action])\n  @@index([createdAt])\n}\n\n// ═══════════════════════════════════════════════════════════════════════════════\n// LOYALTY MANAGEMENT\n// ═══════════════════════════════════════════════════════════════════════════════\n\nenum AccountStatus {\n  ACTIVE\n  INACTIVE\n  FROZEN\n  CLOSED\n}\n\nmodel Account {\n  id                BigInt    @id @default(autoincrement())\n  restaurantId      BigInt\n  userId            BigInt?\n  accountNumber     String    @unique\n  status            AccountStatus @default(ACTIVE)\n  balance           Decimal   @default(0) @db.Numeric(10, 2)\n  createdAt         DateTime  @default(now())\n  updatedAt         DateTime  @updatedAt\n\n  // Relations\n  guests            Guest[]\n  payments          Payment[]\n\n  @@index([userId])\n  @@index([status])\n}\n\nenum GuestStatus {\n  ACTIVE\n  INACTIVE\n  VIP\n  BLACKLISTED\n}\n\nmodel Guest {\n  id                BigInt    @id @default(autoincrement())\n  restaurantId      BigInt\n  accountId         BigInt?\n  firstName         String\n  lastName          String\n  email             String?\n  phone             String?\n  birthDate         DateTime?\n  status            GuestStatus @default(ACTIVE)\n  totalSpent        Decimal   @default(0) @db.Numeric(12, 2)\n  visitCount        Int       @default(0)\n  lastVisitAt       DateTime?\n  createdAt         DateTime  @default(now())\n  updatedAt         DateTime  @updatedAt\n\n  // Relations\n  account           Account?  @relation(fields: [accountId], references: [id])\n  loyaltyCards      LoyaltyCard[]\n  orders            Order[]\n\n  @@index([restaurantId])\n  @@index([status])\n  @@index([phone])\n  @@index([email])\n}\n\nenum CardStatus {\n  ACTIVE\n  INACTIVE\n  EXPIRED\n  BLOCKED\n}\n\nmodel LoyaltyCard {\n  id                BigInt    @id @default(autoincrement())\n  guestId           BigInt\n  cardNumber        String    @unique\n  status            CardStatus @default(ACTIVE)\n  ballsBalance      Int       @default(0)\n  expiresAt         DateTime\n  createdAt         DateTime  @default(now())\n  updatedAt         DateTime  @updatedAt\n\n  // Relations\n  guest             Guest     @relation(fields: [guestId], references: [id], onDelete: Cascade)\n\n  @@index([guestId])\n  @@index([cardNumber])\n  @@index([status])\n}\n\nmodel Order {\n  id                BigInt    @id @default(autoincrement())\n  restaurantId      BigInt\n  guestId           BigInt?\n  orderNumber       String    @unique\n  total             Decimal   @db.Numeric(10, 2)\n  ballsEarned       Int       @default(0)\n  ballsSpent        Int       @default(0)\n  createdAt         DateTime  @default(now())\n  updatedAt         DateTime  @updatedAt\n\n  // Relations\n  guest             Guest?    @relation(fields: [guestId], references: [id])\n  items             OrderItem[]\n  payment           Payment?\n\n  @@index([restaurantId])\n  @@index([guestId])\n  @@index([orderNumber])\n}\n\nmodel OrderItem {\n  id                BigInt    @id @default(autoincrement())\n  orderId           BigInt\n  name              String\n  quantity          Int\n  price             Decimal   @db.Numeric(10, 2)\n  total             Decimal   @db.Numeric(10, 2)\n\n  // Relations\n  order             Order     @relation(fields: [orderId], references: [id], onDelete: Cascade)\n\n  @@index([orderId])\n}\n\nenum PaymentStatus {\n  PENDING\n  COMPLETED\n  FAILED\n  REFUNDED\n}\n\nmodel Payment {\n  id                BigInt    @id @default(autoincrement())\n  orderId           BigInt    @unique\n  accountId         BigInt?\n  amount            Decimal   @db.Numeric(10, 2)\n  status            PaymentStatus @default(PENDING)\n  method            String?   // cash, card, mobile, etc.\n  transactionId     String?   @unique\n  createdAt         DateTime  @default(now())\n  updatedAt         DateTime  @updatedAt\n\n  // Relations\n  order             Order     @relation(fields: [orderId], references: [id], onDelete: Cascade)\n  account           Account?  @relation(fields: [accountId], references: [id])\n\n  @@index([accountId])\n  @@index([status])\n  @@index([transactionId])\n}\n"}</_requires_user_approval>
</invoke>